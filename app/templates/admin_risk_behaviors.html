
{% extends "base.html" %}

{% block content %}
<style>
  h2 {
    text-align: center;
    color: #00cec9;
    margin-bottom: 30px;
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: rgba(45, 52, 54, 0.8);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    border-left: 4px solid #00cec9;
  }

  .stat-number {
    font-size: 2em;
    color: #00cec9;
    font-weight: bold;
  }

  .stat-label {
    color: #ecf0f1;
    margin-top: 5px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(45, 52, 54, 0.8);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 30px;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #34495e;
  }

  th {
    background: rgba(0, 206, 201, 0.2);
    color: #00cec9;
    font-weight: bold;
  }

  td {
    color: #ecf0f1;
  }

  tr:hover td {
    background-color: rgba(0, 206, 201, 0.1);
  }

  .risk-low { color: #2ecc71; }
  .risk-medium { color: #f39c12; }
  .risk-high { color: #e74c3c; }

  .behavior-type {
    background: rgba(0, 206, 201, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
  }
  
  .action-link {
    color: #00cec9;
    text-decoration: none;
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.3s;
  }
  
  .action-link:hover {
    background-color: rgba(0, 206, 201, 0.2);
  }

  .pagination-container {
    text-align: center;
    margin: 30px 0;
  }

  .pagination {
    display: inline-flex;
    gap: 10px;
    align-items: center;
    background: rgba(45, 52, 54, 0.8);
    padding: 15px 25px;
    border-radius: 25px;
  }

  .pagination a, .pagination span {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 8px;
    color: #00cec9;
    text-decoration: none;
  }

  .pagination a:hover {
    background-color: #00cec9;
    color: #2d3436;
  }

  .pagination .current {
    background-color: #00cec9;
    color: #2d3436;
  }

  .pagination .disabled {
    color: #7f8c8d;
    cursor: not-allowed;
  }
</style>

{% if current_filter != 'all' %}
  {% for user in users if user.id|string == current_filter %}
    <h2>⚠️ Risk Behaviors - {{ user.username }}</h2>
  {% endfor %}
{% else %}
  <h2>⚠️ Risk Behaviors - All Users</h2>
{% endif %}

<!-- User Filter and Add Sample Data -->
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
  <div>
    <a href="{{ url_for('main.add_sample_risk_behaviors') }}" style="background: rgba(0, 206, 201, 0.8); color: #ecf0f1; padding: 8px 15px; border-radius: 5px; text-decoration: none; display: inline-block;">
      <i class="fas fa-plus-circle"></i> Add Sample Data
    </a>
  </div>
  
  <div>
    <form action="{{ url_for('main.risk_behaviors') }}" method="get" style="display: inline-block;">
      <label for="user-filter" style="color: #ecf0f1; margin-right: 10px;">Filter by User:</label>
      <select id="user-filter" name="user" onchange="this.form.submit()" style="background: rgba(45, 52, 54, 0.8); color: #ecf0f1; padding: 8px; border-radius: 5px; border: 1px solid #00cec9;">
        <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Users</option>
        {% for user in users %}
        <option value="{{ user.id }}" {% if current_filter|int == user.id %}selected{% endif %}>{{ user.username }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
</div>

<!-- Users with Risk Behaviors -->
<div style="margin-bottom: 30px; background: rgba(45, 52, 54, 0.8); padding: 20px; border-radius: 10px; border-left: 4px solid #00cec9;">
  <h3 style="color: #00cec9; margin-top: 0; margin-bottom: 15px;">Users with Risk Behaviors</h3>
  
  {% if users_with_behaviors %}
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
      {% set displayed_users = [] %}
      {% for user in users_with_behaviors %}
        {% if user.username not in displayed_users %}
          <a href="{{ url_for('main.risk_behaviors', user=user.id) }}" style="background: rgba(0, 206, 201, 0.2); color: #ecf0f1; padding: 8px 15px; border-radius: 20px; text-decoration: none; display: inline-block;">
            {{ user.username }}
          </a>
          {% set _ = displayed_users.append(user.username) %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p style="color: #ecf0f1;">No users with risk behaviors found.</p>
  {% endif %}
</div>

<div class="stats-container">
  <div class="stat-card">
    <div class="stat-number">{{ behaviors.total }}</div>
    <div class="stat-label">Total Behaviors</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ behaviors.items | selectattr('risk_score', 'ge', 40) | list | length }}</div>
    <div class="stat-label">High Risk</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ behaviors.items | map(attribute='risk_score') | sum }}</div>
    <div class="stat-label">Total Risk Points</div>
  </div>
</div>

<table>
  <tr>
    <th>#</th>
    <th>User</th>
    <th>Behavior</th>
    <th>Domain</th>
    <th>Risk Score</th>
    <th>Date</th>
    <th>Actions</th>
  </tr>
  {% for behavior in behaviors.items %}
  <tr style="cursor: pointer;" onclick="window.location='{{ url_for('main.view_risk_behavior', behavior_id=behavior.id) }}'">
    <td>{{ ((behaviors.page - 1) * behaviors.per_page) + loop.index }}</td>
    <td>{{ behavior.user.username if behavior.user else 'Anonymous' }}</td>
    <td>
      <span class="behavior-type">
        {{ behavior.behavior_type.replace('_', ' ').title() }}
      </span>
    </td>
    <td>{{ behavior.domain or 'N/A' }}</td>
    <td class="{% if behavior.risk_score >= 40 %}risk-high{% elif behavior.risk_score >= 20 %}risk-medium{% else %}risk-low{% endif %}">
      {{ behavior.risk_score }}
    </td>
    <td>{{ behavior.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
    <td>
      <a href="{{ url_for('main.view_risk_behavior', behavior_id=behavior.id) }}" class="action-link">
        <i class="fas fa-eye"></i> View
      </a>
    </td>
  </tr>
  {% endfor %}
</table>

<!-- Pagination -->
<div class="pagination-container">
  <div class="pagination">
    {% if behaviors.has_prev %}
      <a href="{{ url_for('main.risk_behaviors', page=1, user=current_filter) }}">⏮️ First</a>
      <a href="{{ url_for('main.risk_behaviors', page=behaviors.prev_num, user=current_filter) }}">⬅️ Previous</a>
    {% else %}
      <span class="disabled">⏮️ First</span>
      <span class="disabled">⬅️ Previous</span>
    {% endif %}

    {% for page_num in behaviors.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
      {% if page_num %}
        {% if page_num != behaviors.page %}
          <a href="{{ url_for('main.risk_behaviors', page=page_num, user=current_filter) }}">{{ page_num }}</a>
        {% else %}
          <span class="current">{{ page_num }}</span>
        {% endif %}
      {% else %}
        <span>…</span>
      {% endif %}
    {% endfor %}

    {% if behaviors.has_next %}
      <a href="{{ url_for('main.risk_behaviors', page=behaviors.next_num, user=current_filter) }}">Next ➡️</a>
      <a href="{{ url_for('main.risk_behaviors', page=behaviors.pages, user=current_filter) }}">Last ⏭️</a>
    {% else %}
      <span class="disabled">Next ➡️</span>
      <span class="disabled">Last ⏭️</span>
    {% endif %}
  </div>
</div>

{% endblock %}
